MEGA-PROMPT ДЛЯ REPLIT / CODEX
Проект: Village Drewno (база отдыха) + отдельный модуль квадроциклов (сторонняя компания)

ЦЕЛЬ
1) Полностью заменить старую систему админ-задач (удалить старые расписания/шаблоны/уведомления) на новые:
   - уведомления не раньше 08:00
   - каналы: Telegram + Приложение (раздел "Задачи")
2) Добавить модуль "Пульт прачечной" для администратора с учётом операций (сдал/повёз/забрал) и записью в таблицу.
3) Ввести RBAC и кассовые ограничения:
   - Администратор базы отдыха НЕ может делать инкассацию (кнопку убрать, API запретить)
   - Owner (Собственник) может делать инкассацию ТОЛЬКО для базы отдыха (домики/бани/спа)
   - Квадроциклы = отдельная касса и отдельная роль (Instructor/ATV-Operator). Owner видит отчёты, но НЕ делает инкассацию по квадроциклам (read-only).
   - Администратор базы отдыха не имеет отношения к квадроциклам (не видит/не управляет).
4) Гарантировать отсутствие потерь данных при обновлениях (баня/бронь/квадроциклы/задачи): миграции без сброса коллекций/таблиц.

ОКРУЖЕНИЕ
- Таймзона: Europe/Minsk (UTC+3)
- Уведомления запрещены до 08:00 (quiet hours).
- Телеграм-бот уже умеет слать уведомления с кнопкой "Открыть задачу" — сохранить, расширить.
- Данные писать в таблицу (Google Sheets) + хранить в БД (для надежности и аналитики).
  (Если в проекте уже есть Sheets интеграция — использовать. Если нет — добавить через service account key.)

ВАЖНО: ничего не ломать в существующей авторизации и существующих базах бронирований.
Любые изменения через миграции и feature flags, без удаления данных.

========================================
A) РОЛИ И ДОСТУПЫ (RBAC)
========================================
1) Добавить/уточнить роли:
- OWNER: полный доступ к базе отдыха, отчёты по квадроциклам (read-only), инкассация базы отдыха.
- ADMIN_REST: администратор базы отдыха: задачи, прачечная, баня, домики, смена, дневная касса (просмотр), но без инкассации.
- ATV_INSTRUCTOR: инструктор квадроциклов: видит только квадроциклы/их кассу/бронь, не видит базу отдыха.
- ATV_OWNER (опционально): владелец сторонней компании квадроциклов (если нужен) — инкассация квадроциклов у них.
2) Запреты:
- ADMIN_REST: запрет на "инкассация" (UI + API). Любая попытка API должна возвращать 403.
- OWNER: запрет на инкассацию квадроциклов (UI скрыть + API 403/readonly).
3) UI:
- убрать кнопку "Инкассация" в админ-панели и в мобильном приложении для роли ADMIN_REST.
- для OWNER оставить инкассацию только в модуле базы отдыха.
- в модуле квадроциклов owner видит только dashboard/цифры (без действий).

========================================
B) РАЗДЕЛЕНИЕ КАСС (LEDGER)
========================================
1) Завести два независимых ledger:
- ledger_rest (база отдыха: домики/бани/спа)
- ledger_atv (квадроциклы: отдельная компания)
2) Любые операции денег обязаны иметь ledger_id.
3) Отчёты:
- ADMIN_REST видит daily cash + переходный остаток по ledger_rest.
- OWNER видит сводку по обоим ledger, но действия (инкассация) только по ledger_rest.
- ATV_INSTRUCTOR видит ledger_atv (в пределах своей роли).

========================================
C) ЗАДАЧИ И УВЕДОМЛЕНИЯ (НОВЫЙ РЕЖИМ)
========================================
0) Удалить/отключить старые расписания задач:
- найти старые cron/agenda/bullmq repeatable jobs, которые создают "ежедневные/еженедельные/ежемесячные" задачи.
- выключить их (feature flag TASKS_V1=false) и удалить UI ссылки на старые шаблоны.
- миграция: старые записи задач не удалять из БД, но скрыть из интерфейса (архивировать).

1) Базовое правило уведомлений:
- если задача создается раньше 08:00, уведомление откладывается на 08:00.
- если задача создается в любое другое время — уведомлять сразу по расписанию.
- каналы: Telegram + in-app уведомление/бейдж + запись в "Задачи".

2) Месячные задачи (ТОЛЬКО счётчики, 1-го числа)
В 08:00 1-го числа каждого месяца:
- Task: "Снять показания счётчика №1 (котельная)"
  * форма: одно поле meter_value (строка/число), опционально фото
  * кнопка "Отправить"
  * после отправки: task -> done и скрыть у админа
  * owner получает уведомление с цифрами
  * запись в таблицу + БД: meter_readings
- Task: "Снять показания счётчика №2 (поле)"
  * аналогично

Сущность MeterReading:
- id, meter_id (1/2), meter_name, value, photo_url(optional), created_at, created_by(admin_id), source(telegram/app)

3) Ежедневные уведомления для администратора базы отдыха:
- 08:30 "Открыть смену" (task: open_shift)
- 09:00 "Сводка по баням на сегодня" (не задача для ввода, а уведомление + кнопка "Открыть брони бань")
  Содержание: баня, время, телефон, сумма к оплате, предоплата, остаток.
- 12:00 "Отключить кондиционеры/тёплые полы в домиках БЕЗ заселения"
  Внутри: список домиков без заезда сегодня (данные из бронирований)
  Кнопка: "Отметить выполнено"
- 14:00 "Включить кондиционер/тёплый пол в домиках С заселением"
  Внутри: список домиков с заездом сегодня
  Кнопка: "Отметить выполнено"

ВАЖНО: уведомления и задачи не должны ломать существующую базу бронирований домиков/бань.
Только чтение бронирований, никакого сброса.

========================================
D) ПУЛЬТ ПРАЧЕЧНОЙ (НОВЫЙ МОДУЛЬ)
========================================
Цель: админ ведет учет прачечной по операциям, owner видит аналитику, всё пишется в таблицу и БД.

1) Сущности:
LaundrySettings:
- id, pickup_days (массив дней недели), dropoff_days (массив дней недели), updated_by, updated_at

LaundryBatch (партия/рейс):
- id, status: DRAFT | SENT_TO_LAUNDRY | IN_LAUNDRY | RETURNED | CLOSED
- created_at, created_by
- sent_at, sent_by
- returned_at, returned_by
- notes

LaundryLineItem:
- id, batch_id
- item_type (например: "постельное", "полотенца", "халаты", "скатерти", др.)
- qty_sent (шт)
- kg_sent (кг, optional)
- qty_returned (шт, optional)
- kg_returned (кг, optional)

2) UX/Флоу для администратора:
Экран "Прачечная":
- Блок "График":
  * выбрать дни "Завоз" и дни "Забор" (чекбоксы по дням недели)
  * сохранить (пишется в LaundrySettings)
- Блок "Текущая партия":
  * кнопка "Создать партию"
  * ввод: список позиций (тип + количество шт + (опц) кг)
  * кнопка "Отправить в прачечную" -> статус SENT_TO_LAUNDRY + фиксируем время + кто отправил
- Блок "Забор из прачечной":
  * выбрать партию SENT_TO_LAUNDRY/IN_LAUNDRY
  * ввести "сколько кг по факту" (kg_returned) и (опц) qty_returned
  * кнопка "Забрал" -> статус RETURNED
- Кнопка "Закрыть партию" -> статус CLOSED

3) Таблица/логирование:
Каждое действие пишет строку в Google Sheets:
- date_time, action(SENT/RETURNED/CLOSED), batch_id, item_type, qty, kg, admin_name, notes

4) Уведомления по прачечной:
- В дни "Завоз" в 10:00 (не раньше 08:00): напоминание "Сегодня завоз прачки" + кнопка открыть прачечную
- В дни "Забор" в 10:00: напоминание "Сегодня забрать прачку" + кнопка открыть прачечную
- После "Отправить" и "Забрал": owner получает короткое уведомление (сколько позиций/кг)

========================================
E) МОРОЗНЫЕ АЛЕРТЫ (ПОГОДА)
========================================
Локация: Великорита / Пожежин (Малоритский район, Брестская обл.). :contentReference[oaicite:1]{index=1}
Использовать Open-Meteo Forecast API (без ключа). :contentReference[oaicite:2]{index=2}

1) Ежедневная проверка прогноза:
- каждый день в 18:00 (Europe/Minsk) проверять прогноз температуры на ближайшие 24-36 часов
- если ожидается min_temp <= -3°C (порог настраиваемый):
  создать задачи для ADMIN_REST (уведомить не раньше 18:00, это ок):
    a) "Проверить/развоздушить воду для купелей"
    b) "Проверить, чтобы не замерзло (водоподготовка/шланги/краны)"
  + утром (08:30) если мороз был/будет:
    c) "Предложение: растопить баню" (если есть брони/или просто рекомендация)
    d) "Включить обогреватель в складе с постельным бельём"

2) Реализация:
- создать service WeatherService:
  * хранит координаты объекта (lat/lon) в конфиге
  * делает запрос к Open-Meteo и вычисляет min_temp в заданном окне
  * пишет лог и сохраняет последнее срабатывание, чтобы не спамить (1 раз в сутки максимум)
- добавить таблицу WeatherAlertLog:
  * date, min_temp, triggered(bool), tasks_created(list)

========================================
F) НЕСБРАСЫВАЕМОСТЬ БАЗ (МИГРАЦИИ/ОБНОВЛЕНИЯ)
========================================
Требования:
1) Никаких reset/seed в production.
2) Добавлять новые коллекции/таблицы только миграциями:
- если Mongo: использовать migrate-mongo/скрипты версионирования
- если Postgres: Prisma migrations/Knex migrations
3) Версионирование:
- добавить schema version
- при деплое запускать миграции перед стартом приложения
4) Бэкап:
- перед миграцией сделать автоматический backup (если предусмотрено окружением) или вывести инструкцию.
5) В коде: все новые фичи за флагом:
- TASKS_V2=true
- LAUNDRY_MODULE=true
- RBAC_STRICT=true

========================================
G) ЧТО СДЕЛАТЬ В КОДЕ (КОНКРЕТНЫЕ ИЗМЕНЕНИЯ)
========================================
1) Backend:
- Модели/сущности: Task, TaskTemplateV2, MeterReading, LaundrySettings, LaundryBatch, LaundryLineItem, WeatherAlertLog, Ledger
- RBAC middleware: requireRole(), requireLedgerAccess()
- API:
  * POST /api/tasks/submit-meter-reading
  * POST /api/laundry/batch (create)
  * POST /api/laundry/batch/:id/send
  * POST /api/laundry/batch/:id/return
  * POST /api/laundry/batch/:id/close
  * GET /api/reports/ledger (owner)
  * POST /api/cashout (owner only, ledger_rest only)
- Jobs (BullMQ/cron):
  * monthly meters (1st day 08:00)
  * daily open shift (08:30)
  * daily sauna summary (09:00)
  * daily 12:00 / 14:00 heating toggles tasks
  * laundry reminders based on LaundrySettings
  * weather frost check (18:00) + morning reminders (08:30)

2) Telegram bot:
- Команды/кнопки:
  * "Открыть задачу"
  * "Ввести показания счётчика №1/№2" -> запросить цифры -> подтвердить отправку
  * "Открыть прачечную" -> быстрые действия (создать партию, отправить, забрать)
- После submit всегда подтверждение + ссылка на задачу.

3) Frontend (приложение/админка):
- Новый раздел "Задачи" (если уже есть — расширить)
- Новый раздел "Прачечная" видимый только ADMIN_REST и OWNER (owner read/write? owner можно read-only по настройке)
- Скрыть "Инкассация" для ADMIN_REST
- В модуле квадроциклов:
  * скрыть всё от ADMIN_REST
  * owner видит только dashboard (read-only)

========================================
H) ТЕСТЫ И ПРОВЕРКИ
========================================
1) Unit tests:
- RBAC: админ не может cashout
- owner не может cashout ledger_atv
- admin не видит atv endpoints
2) Integration tests:
- monthly meters create 2 tasks at 08:00 on 1st
- submit meter reading -> записалось в БД + ушло owner уведомление + строка в sheets (можно мок)
3) Regression:
- убедиться что таблицы/коллекции бронирований бань/домиков/квадроциклов не изменены и не очищаются
- убедиться, что старые задачи скрыты/архивированы, но не удалены

ФИНАЛ
Сделать PR с изменениями, описать в README:
- переменные окружения (Sheets key, Telegram token, Open-Meteo coords, timezone)
- как включить флаги
- как запустить миграции
- как откатить

СДЕЛАЙ ЭТО АККУРАТНО, БЕЗ СБРОСА ДАННЫХ, С КОММЕНТАРИЯМИ В КОДЕ И ЯСНЫМИ ЛОГАМИ.
