root@server-srekbm:/var/www/drewno-ops# # 1. Исправить пароль пользователя в PostgreSQL
root@server-srekbm:/var/www/drewno-ops# sudo -u postgres psql -c "ALTER USER drewno PASSWORD '39903990aSs\$';"

# 2. Создать .env файл для drizzle-kit
cat > /var/www/drewno-ops/.env << 'EOF'
DATABASE_URL=postgresql://drewno:39903990aSs%24@localhost:5432/drewno
EOF

# 3. Подтянуть изменения и обновить
cd /var/www/drewno-ops && git pull origin main && npm run build

# 4. Запустить миграции
npm run db:push

# 5. Перезапустить приложение
pm2 delete drewno-ops && pm2 start /var/www/drewno-ops/ecosystem.config.cjs && pm2 saveALTER ROLE
root@server-srekbm:/var/www/drewno-ops#
root@server-srekbm:/var/www/drewno-ops# # 1. Исправить пароль пользователя в PostgreSQL
sudo -u postgres psql -c "ALTER USER drewno PASSWORD '39903990aSs\$';"

# 2. Создать .env файл для drizzle-kit
cat > /var/www/drewno-ops/.env << 'EOF'
DATABASE_URL=postgresql://drewno:39903990aSs%24@localhost:5432/drewno
EOF

# 3. Подтянуть изменения и обновить
cd /var/www/drewno-ops && git pull origin main && npm run build

# 4. Запустить миграции
npm run db:push

# 5. Перезапустить приложение
pm2 delete drewno-ops && pm2 start /var/www/drewno-ops/ecosystem.config.cjs && pm2 save
ALTER ROLE
remote: Enumerating objects: 19, done.
remote: Counting objects: 100% (19/19), done.
remote: Compressing objects: 100% (5/5), done.
remote: Total 13 (delta 8), reused 13 (delta 8), pack-reused 0 (from 0)
Unpacking objects: 100% (13/13), 360.72 KiB | 1.84 MiB/s, done.
From https://github.com/Alexseibr/Drewnobot
 * branch            main       -> FETCH_HEAD
   c526d36..6c4a9ce  main       -> origin/main
Updating c526d36..6c4a9ce
Fast-forward
 attached_assets/IMG_7826_1770283087156.png                                 | Bin 393957 -> 0 bytes
 ...lcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770282813148.txt |  53 ---
 ...lcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288866624.txt |  76 -----
 ...lcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288921220.txt | 159 ---------
 ...lcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288989463.txt | 275 ---------------
 ...no-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770281992814.txt | 111 ------
 ...no-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770282038950.txt | 111 ------
 ...no-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770282102891.txt | 111 ------
 ...d-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289036076.txt |  61 ----
 ...d-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289063687.txt | 145 --------
 ...d-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289109613.txt | 530 -----------------------------
 ...d-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289151955.txt | 622 ----------------------------------
 ...ot-server-srekbm-var-www-drewno-ops-cat-var-www-drewn_1770289343575.txt |  90 -----
 ...ot-server-srekbm-var-www-drewno-ops-root-server-srekb_1770290283919.txt | 133 ++++++++
 attached_assets/image_1770290172856.png                                    | Bin 0 -> 247780 bytes
 attached_assets/image_1770290237729.png                                    | Bin 0 -> 218896 bytes
 client/src/pages/landing.tsx                                               |  25 +-
 17 files changed, 157 insertions(+), 2345 deletions(-)
 delete mode 100644 attached_assets/IMG_7826_1770283087156.png
 delete mode 100644 attached_assets/Pasted-Welcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770282813148.txt
 delete mode 100644 attached_assets/Pasted-Welcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288866624.txt
 delete mode 100644 attached_assets/Pasted-Welcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288921220.txt
 delete mode 100644 attached_assets/Pasted-Welcome-to-Ubuntu-22-04-5-LTS-GNU-Linux-5-15-0-166-gene_1770288989463.txt
 delete mode 100644 attached_assets/Pasted-ewno-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770281992814.txt
 delete mode 100644 attached_assets/Pasted-ewno-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770282038950.txt
 delete mode 100644 attached_assets/Pasted-ewno-app-bash-cd-home-drewno-app-No-such-file-or-direct_1770282102891.txt
 delete mode 100644 attached_assets/Pasted-led-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289036076.txt
 delete mode 100644 attached_assets/Pasted-led-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289063687.txt
 delete mode 100644 attached_assets/Pasted-led-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289109613.txt
 delete mode 100644 attached_assets/Pasted-led-for-user-user-C-root-server-srekbm-var-www-drewno-o_1770289151955.txt
 delete mode 100644 attached_assets/Pasted-root-server-srekbm-var-www-drewno-ops-cat-var-www-drewn_1770289343575.txt
 create mode 100644 attached_assets/Pasted-root-server-srekbm-var-www-drewno-ops-root-server-srekb_1770290283919.txt
 create mode 100644 attached_assets/image_1770290172856.png
 create mode 100644 attached_assets/image_1770290237729.png

> rest-express@1.0.0 build
> tsx script/build.ts

building client...
vite v7.3.0 building client environment for production...
transforming (1) src/main.tsx
A PostCSS plugin did not pass the `from` option to `postcss.parse`. This may cause imported assets to be incorrectlytransformed. If you've recently added a PostCSS plugin that raised this warning, please contact the package author to fix the issue.
✓ 3222 modules transformed.
../dist/public/index.html                            1.07 kB │ gzip:   0.60 kB
../dist/public/assets/drewno-logo-Bw8WbCk8.webp    328.56 kB
../dist/public/assets/index-C2H21Ask.css            85.86 kB │ gzip:  14.07 kB
../dist/public/assets/index-DVU6mgYR.js          1,334.66 kB │ gzip: 355.14 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 18.85s
building server...

  dist/index.cjs  1.3mb ⚠️

⚡ Done in 343ms

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/var/www/drewno-ops/drizzle.config.ts'
Using 'pg' driver for database querying
[✓] Pulling schema from database...
+ cleaning_logs table will be created
+ cleaning_rates table will be created
+ cleaning_workers table will be created
+ hourly_logs table will be created
+ salary_periods table will be created
--- all table conflicts resolved ---

 Warning  Found data-loss statements:
· You're about to delete travelline_bookings table with 20 items

THIS ACTION WILL CAUSE DATA LOSS AND CANNOT BE REVERTED

Do you still want to push changes?
[x] All changes were aborted
[PM2] Applying action deleteProcessId on app [drewno-ops](ids: [ 0 ])
[PM2] [drewno-ops](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2][WARN] Applications drewno-ops not running, starting...
[PM2] App [drewno-ops] launched (1 instances)
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ drewno-ops         │ fork     │ 0    │ online    │ 0%       │ 18.5mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
[PM2] Saving current process list...
[PM2] Successfully saved in /root/.pm2/dump.pm2
root@server-srekbm:/var/www/drewno-ops# # Перейти в папку проекта (уточните путь)
root@server-srekbm:/var/www/drewno-ops# cd /var/www/drewno-ops
root@server-srekbm:/var/www/drewno-ops# # или
root@server-srekbm:/var/www/drewno-ops# cd /home/drewno/app
-bash: cd: /home/drewno/app: No such file or directory
root@server-srekbm:/var/www/drewno-ops#
root@server-srekbm:/var/www/drewno-ops# # Затем подтянуть изменения
root@server-srekbm:/var/www/drewno-ops# git pull origin main
From https://github.com/Alexseibr/Drewnobot
 * branch            main       -> FETCH_HEAD
Already up to date.
root@server-srekbm:/var/www/drewno-ops#
root@server-srekbm:/var/www/drewno-ops# # Установить зависимости
root@server-srekbm:/var/www/drewno-ops# npm install

up to date, audited 500 packages in 3s

68 packages are looking for funding
  run `npm fund` for details

4 vulnerabilities (1 moderate, 3 high)

To address all issues, run:
  npm audit fix

Run `npm audit` for details.
root@server-srekbm:/var/www/drewno-ops#
root@server-srekbm:/var/www/drewno-ops# # Собрать проект
root@server-srekbm:/var/www/drewno-ops# npm run build

> rest-express@1.0.0 build
> tsx script/build.ts

building client...
vite v7.3.0 building client environment for production...
transforming (1) src/main.tsx
A PostCSS plugin did not pass the `from` option to `postcss.parse`. This may cause imported assets to be incorrectlytransformed. If you've recently added a PostCSS plugin that raised this warning, please contact the package author to fix the issue.
✓ 3222 modules transformed.
../dist/public/index.html                            1.07 kB │ gzip:   0.60 kB
../dist/public/assets/drewno-logo-Bw8WbCk8.webp    328.56 kB
../dist/public/assets/index-C2H21Ask.css            85.86 kB │ gzip:  14.07 kB
../dist/public/assets/index-DVU6mgYR.js          1,334.66 kB │ gzip: 355.14 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 22.01s
building server...

  dist/index.cjs  1.3mb ⚠️

⚡ Done in 405ms
root@server-srekbm:/var/www/drewno-ops#
root@server-srekbm:/var/www/drewno-ops# # Перезапустить
root@server-srekbm:/var/www/drewno-ops# pm2 restart drewno-ops
Use --update-env to update environment variables
[PM2] Applying action restartProcessId on app [drewno-ops](ids: [ 0 ])
[PM2] [drewno-ops](0) ✓
┌────┬────────────────────┬──────────┬──────┬───────────┬──────────┬──────────┐
│ id │ name               │ mode     │ ↺    │ status    │ cpu      │ memory   │
├────┼────────────────────┼──────────┼──────┼───────────┼──────────┼──────────┤
│ 0  │ drewno-ops         │ fork     │ 1    │ online    │ 0%       │ 24.2mb   │
└────┴────────────────────┴──────────┴──────┴───────────┴──────────┴──────────┘
root@server-srekbm:/var/www/drewno-ops# pm2 logs drewno-ops --lines 50
[TAILING] Tailing last 50 lines for [drewno-ops] process (change the value with --lines option)
/root/.pm2/logs/drewno-ops-error.log last 50 lines:
0|drewno-o |     at async EC.mt.default.schedule.timezone (/var/www/drewno-ops/dist/index.cjs:216:124728)
0|drewno-o |     at async Timeout._onTimeout (/var/www/drewno-ops/node_modules/node-cron/dist/cjs/scheduler/runner.js:70:44) {
0|drewno-o |   length: 102,
0|drewno-o |   severity: 'FATAL',
0|drewno-o |   code: '28P01',
0|drewno-o |   detail: undefined,
0|drewno-o |   hint: undefined,
0|drewno-o |   position: undefined,
0|drewno-o |   internalPosition: undefined,
0|drewno-o |   internalQuery: undefined,
0|drewno-o |   where: undefined,
0|drewno-o |   schema: undefined,
0|drewno-o |   table: undefined,
0|drewno-o |   column: undefined,
0|drewno-o |   dataType: undefined,
0|drewno-o |   constraint: undefined,
0|drewno-o |   file: 'auth.c',
0|drewno-o |   line: '343',
0|drewno-o |   routine: 'auth_failed'
0|drewno-o | }
0|drewno-o | [Telegram Bot] API error: setWebhook { ok: false, error_code: 404, description: 'Not Found' }
0|drewno-o | [Telegram Bot] API error: setMyCommands { ok: false, error_code: 404, description: 'Not Found' }
0|drewno-o | [ThermostatScheduler] Failed to initialize houses (table may not exist yet): password authentication failed for user "drewno"
0|drewno-o | [Telegram Bot] Error handling update: error: password authentication failed for user "drewno"
0|drewno-o |     at /var/www/drewno-ops/dist/index.cjs:64:13326
0|drewno-o |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|drewno-o |     at async /var/www/drewno-ops/dist/index.cjs:70:37916
0|drewno-o |     at async Ku.getUserByTelegramId (/var/www/drewno-ops/dist/index.cjs:70:86690)
0|drewno-o |     at async lo (/var/www/drewno-ops/dist/index.cjs:74:493)
0|drewno-o |     at async Eg (/var/www/drewno-ops/dist/index.cjs:82:683)
0|drewno-o |     at async /var/www/drewno-ops/dist/index.cjs:216:114003 {
0|drewno-o |   length: 102,
0|drewno-o |   severity: 'FATAL',
0|drewno-o |   code: '28P01',
0|drewno-o |   detail: undefined,
0|drewno-o |   hint: undefined,
0|drewno-o |   position: undefined,
0|drewno-o |   internalPosition: undefined,
0|drewno-o |   internalQuery: undefined,
0|drewno-o |   where: undefined,
0|drewno-o |   schema: undefined,
0|drewno-o |   table: undefined,
0|drewno-o |   column: undefined,
0|drewno-o |   dataType: undefined,
0|drewno-o |   constraint: undefined,
0|drewno-o |   file: 'auth.c',
0|drewno-o |   line: '343',
0|drewno-o |   routine: 'auth_failed'
0|drewno-o | }
0|drewno-o | Error: ENOENT: no such file or directory, stat '/var/www/drewno-ops/dist/public/index.html'

/root/.pm2/logs/drewno-ops-out.log last 50 lines:
0|drewno-o | 2:21:00 PM [scheduler]     - Prompt: 12:00 daily
0|drewno-o | 2:21:00 PM [scheduler]     - Base temps: 12:05 daily
0|drewno-o | 2:21:00 PM [scheduler]     - Heating: 14:30 daily
0|drewno-o | 2:21:00 PM [scheduler]   - SPA Guest Notifications:
0|drewno-o | 2:21:00 PM [scheduler]     - Morning reminder: 09:00 daily
0|drewno-o | 2:21:00 PM [scheduler]     - Access instructions: every 5 min
0|drewno-o | 2:21:00 PM [scheduler] [ThermostatScheduler] Houses initialized
0|drewno-o | 2:21:50 PM [express] GET /api/auth/me 200 in 10ms :: {"id":"9354fddc-eb32-4d80-8856-ebce7c48c663","telegramId":"374243315","name":"А.А","role":"SUPER_ADMIN"}
0|drewno-o | 2:21:50 PM [express] GET /api/ops/today 200 in 85ms :: {"tasks":[{"id":"e8265a71-46ef-4d38-aedf-c5a500456e1b","date":"2026-02-05","type":"other","title":"Утренний обход территории","checklist":["Проверка входа","Осмотр парковки","Проверка освещения"],"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.026Z"},{"id":"362cf095-31fb-4b16-8c0f-b3898dc79f3b","date":"2026-02-05","type":"other","title":"Подготовка дров","checklist":null,"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.091Z"},{"id":"15fa767b-c392-464a-95a9-06ce16fd9b15","date":"2026-02-05","type":"trash_prep","title":"Вынос мусора","checklist":null,"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.097Z"}],"cottageBookings":[],"bathBookings":[],"currentShift":{"id":"a72dc17e-5b0d-4695-849c-d754761ccc9e","openedAt":"2025-12-24T21:34:10.408Z","openedBy":"admin","isOpen":true,"visibleToAdmin":true,"cashBox":"main"},"stats":{"checkInsToday":0,"checkOutsToday":0,"bathsToday":0,"openTasks":3,"cashBalance":13988}}
0|drewno-o | 2:21:50 PM [express] GET /api/cash/shift/current 200 in 59ms :: {"currentShift":{"id":"a72dc17e-5b0d-4695-849c-d754761ccc9e","openedAt":"2025-12-24T21:34:10.408Z","openedBy":"admin","isOpen":true,"visibleToAdmin":true,"cashBox":"main"},"transactions":[],"balance":0}
0|drewno-o | 2:21:53 PM [express] GET /api/admin/cleaning-workers 500 in 10ms :: {"error":"Ошибка загрузки сотрудников"}
0|drewno-o | 2:21:53 PM [express] GET /api/admin/cleaning-rates 500 in 13ms :: {"error":"Ошибка загрузки тарифов"}
0|drewno-o | 2:22:02 PM [express] POST /api/admin/cleaning-workers 500 in 10ms :: {"error":"Ошибка создания сотрудника"}
0|drewno-o |
0|drewno-o | [Process] Received SIGINT, shutting down gracefully...
0|drewno-o | [Process] HTTP server closed
0|drewno-o |
0|drewno-o | > rest-express@1.0.0 start
0|drewno-o | > NODE_ENV=production node dist/index.cjs
0|drewno-o |
0|drewno-o | 2:22:45 PM [express] serving on port 5000
0|drewno-o | [Telegram Bot] Setting up webhook for production: https://d.drewno.by
0|drewno-o | [Telegram Bot] Webhook set successfully
0|drewno-o | [Telegram Bot] Notifications scheduled
0|drewno-o | 2:22:45 PM [scheduler] Scheduler initialized:
0|drewno-o | 2:22:45 PM [scheduler]   - Daily tasks: 06:00 daily
0|drewno-o | 2:22:45 PM [scheduler]   - Weekly tasks: 06:00 Monday
0|drewno-o | 2:22:45 PM [scheduler]   - Monthly tasks: 06:00 1st of month
0|drewno-o | 2:22:45 PM [scheduler]   - Weather check: 18:00 daily
0|drewno-o | 2:22:45 PM [scheduler]   - Scheduled task notifications: every minute
0|drewno-o | 2:22:45 PM [scheduler]   - Nightly chat cleanup: 03:00 daily
0|drewno-o | 2:22:45 PM [scheduler]   - Notifications:
0|drewno-o | 2:22:45 PM [scheduler]     - Bath summary: 09:00 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Climate ON: 12:00 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Climate OFF: 14:00 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Laundry check-in: 15:00 daily
0|drewno-o | 2:22:45 PM [scheduler]   - Thermostat:
0|drewno-o | 2:22:45 PM [scheduler]     - Prompt: 12:00 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Base temps: 12:05 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Heating: 14:30 daily
0|drewno-o | 2:22:45 PM [scheduler]   - SPA Guest Notifications:
0|drewno-o | 2:22:45 PM [scheduler]     - Morning reminder: 09:00 daily
0|drewno-o | 2:22:45 PM [scheduler]     - Access instructions: every 5 min
0|drewno-o | 2:22:45 PM [scheduler] [ThermostatScheduler] Houses initialized
0|drewno-o | 2:22:50 PM [express] GET /api/ops/today 200 in 46ms :: {"tasks":[{"id":"e8265a71-46ef-4d38-aedf-c5a500456e1b","date":"2026-02-05","type":"other","title":"Утренний обход территории","checklist":["Проверка входа","Осмотр парковки","Проверка освещения"],"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.026Z"},{"id":"362cf095-31fb-4b16-8c0f-b3898dc79f3b","date":"2026-02-05","type":"other","title":"Подготовка дров","checklist":null,"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.091Z"},{"id":"15fa767b-c392-464a-95a9-06ce16fd9b15","date":"2026-02-05","type":"trash_prep","title":"Вынос мусора","checklist":null,"status":"open","priority":"normal","notified":false,"createdBySystem":true,"meta":null,"createdAt":"2026-02-05T03:00:00.097Z"}],"cottageBookings":[],"bathBookings":[],"currentShift":{"id":"a72dc17e-5b0d-4695-849c-d754761ccc9e","openedAt":"2025-12-24T21:34:10.408Z","openedBy":"admin","isOpen":true,"visibleToAdmin":true,"cashBox":"main"},"stats":{"checkInsToday":0,"checkOutsToday":0,"bathsToday":0,"openTasks":3,"cashBalance":13988}}
0|drewno-o | 2:22:50 PM [express] GET /api/cash/shift/current 200 in 18ms :: {"currentShift":{"id":"a72dc17e-5b0d-4695-849c-d754761ccc9e","openedAt":"2025-12-24T21:34:10.408Z","openedBy":"admin","isOpen":true,"visibleToAdmin":true,"cashBox":"main"},"transactions":[],"balance":0}
0|drewno-o | 2:22:50 PM [express] GET /api/auth/me 200 in 16ms :: {"id":"9354fddc-eb32-4d80-8856-ebce7c48c663","telegramId":"374243315","name":"А.А","role":"SUPER_ADMIN"}
0|drewno-o | 2:22:54 PM [express] GET /api/admin/cleaning-workers 500 in 11ms :: {"error":"Ошибка загрузки сотрудников"}
0|drewno-o | 2:22:54 PM [express] GET /api/admin/cleaning-rates 500 in 14ms :: {"error":"Ошибка загрузки тарифов"}
0|drewno-o | 2:23:00 PM [express] POST /api/admin/cleaning-workers 500 in 8ms :: {"error":"Ошибка создания сотрудника"}

0|drewno-ops  | [Telegram Bot] Checking for SPA access instructions to send...