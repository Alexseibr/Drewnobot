You are Replit Agent / Codex. Implement an MVP “Drewno Ops + Guest Booking” system as a single repo with a Node/NestJS backend + MongoDB + Telegram bot + Telegram Mini App (web UI). This MVP must be production-lean, simple, and safe. Do NOT overbuild. Do NOT break existing future extensibility. Prioritize correctness of booking logic, access control, and scheduled notifications.

========================
0) PROJECT GOALS (MVP)
========================
Build one Telegram bot (single bot) that serves:
A) INTERNAL (Admin/Ops) Mini App for base staff:
- Daily tasks + scheduled reminders (12:10 off climate for empty cottages; 14:30 on climate for cottages with check-in; trash reminders Mon 18:00 and Tue 08:30; monthly meters on day 1 at 09:00)
- Cottage check-ins/check-outs with payments (ERIP, cash, optional prepayment)
- Cleaning tracking with tariffs: Cottages 1–3 = tariff A, Cottage 4 = tariff B, Baths = tariff C
- Tub rules: cottages have ONLY small tub (yes/no); baths have tub type none/small/large
- Cashbox per shift: “cash on hand” tracked; expenses reduce cash; “cash-in” from cash payments; shift “incasation” closes and hides history from admin (admins only see current open shift)
- Additional hourly work logs (time from-to, auto duration calc, free text work type with suggestions, optional hourly rate). After save, admin cannot see history; owner gets notification.

B) GUEST Booking via bot + simple mini app pages:
- Bath booking (Bath 1 or Bath 2) with no overbooking, min 3 hours, must end by 22:00, options tub small/large, grill, charcoal; request creates “pending_call”; admin confirms + records prepayment; on day-of admin closes payment; admin cannot see past history after incasation.
- Quads booking with 4 quads + 1 instructor: treat as instructor sessions (slots) with 30-min buffer after each session; session can include 1–4 quads. Guests see slots availability (remaining quads). Encourage joining an existing session (optional discount rules). Instructor receives notifications and manages quad bookings; day-before reminder to instructor.

Keep the MVP UX minimal: forms, lists, and “confirm/decline” actions. Analytics for owner only: basic counts and totals.

========================
1) TECH STACK
========================
- Backend: NestJS (TypeScript), REST API
- DB: MongoDB (Mongoose)
- Queue/Scheduler: BullMQ + Redis OR simple cron + Mongo (choose BullMQ if feasible quickly; otherwise node-cron)
- Telegram: Telegraf for bot. Telegram Mini App for web.
- Frontend: React + Vite + TypeScript (simple UI), using Telegram WebApp SDK.
- Auth: Telegram initData verification on backend; map telegram user -> role.

========================
2) REPO STRUCTURE
========================
/apps
  /api      (NestJS)
  /webapp   (React Mini App)
/packages
  /shared   (types, validation schemas)
docker-compose.yml (mongo, redis, api, webapp)
.env.example

========================
3) ROLES & ACCESS (CRITICAL)
========================
Roles: OWNER, ADMIN, INSTRUCTOR.
Rules:
- OWNER: full access to all history, analytics, settings.
- ADMIN: can create/update today’s ops items and current shift only. Cannot access historical shifts, historical analytics, or past bookings after shift incasation. Admin can see “today + upcoming” operational items only.
- INSTRUCTOR: can manage only quad sessions and quad bookings assigned to instructor, plus see upcoming schedule; cannot see cashbox, cottage bookings, etc.
Enforce access in API (guards) not just UI.

========================
4) CORE ENTITIES (MONGOOSE SCHEMAS)
========================
(Use “priceSnapshot” fields to freeze amounts at time of event.)

User:
- telegramId (unique), name, phone?, role (OWNER/ADMIN/INSTRUCTOR), isActive

Unit:
- type: 'cottage'|'bath'
- code: 'C1'..'C4' or 'B1'|'B2'
- title
- cleaningTariffCode: 'A'|'B'|'C'
- tubPolicy: 'none'|'small_only'|'small_or_large'
- images: [url]

CleaningTariff:
- code 'A'|'B'|'C'
- title
- price

ServicePrice:
- key: 'bath_base_3h' 'bath_extra_hour' 'tub_small' 'tub_large' 'grill' 'charcoal' 'quad_30m' 'quad_60m'
- price
- currency 'BYN'
- activeFrom?, activeTo?

CottageBooking:
- unitCode (C1..C4)
- dateCheckIn, dateCheckOut (or start/end)
- guestsCount
- tubSmall: boolean (only for cottages)
- totalAmount
- payments: { erip: number, cash: number, prepayment?: { amount:number, method:'erip'|'cash' } }
- customer: { fullName?, phone, telegramId? }
- status: 'planned'|'checked_in'|'completed'|'cancelled'|'no_show'
- createdBy (admin)
- createdAt

BathBooking:
- bathCode (B1|B2)
- date
- startTime, endTime
- minDuration=3h (validate)
- customer: { fullName, phone, telegramId? }
- options: { tub: 'none'|'small'|'large', grill:boolean, charcoal:boolean }
- pricing: { base:number, extras:number, total:number, snapshots:{...} }
- payments: { prepayment?: { amount:number, method:'erip'|'cash' }, eripPaid:number, cashPaid:number }
- status: 'pending_call'|'awaiting_prepayment'|'confirmed'|'cancelled'|'expired'|'completed'
- holdUntil? (optional TTL hold)
- assignedAdmin? (telegramId)
- createdAt

Task:
- date (YYYY-MM-DD)
- unitCode? (C1..C4/B1/B2)
- type: 'climate_off'|'climate_on'|'trash_prep'|'meters'|'cleaning'|'call_guest'|'other'
- title, checklist?: string[]
- status: 'open'|'done'
- assignedTo?: telegramId
- createdBySystem: boolean
- meta: any

CashShift:
- openedAt, closedAt?
- openedBy (admin telegramId)
- isOpen
- visibleToAdmin (always true for open shift; historical shifts not listable for admin)
- computedBalance? (optional)

CashTransaction:
- shiftId
- type: 'cash_in'|'cash_out'|'expense'
- amount
- category?: 'food_staff'|'supplies'|'salary'|'contractor'|'other'
- comment?
- createdAt
- createdBy (admin telegramId)
- location?: { lat, lng, label, accuracy, capturedAt, mode:'on_site'|'off_site' }

WorkLog:
- employeeName (string) OR employeeId optional
- byAdmin (telegramId)
- startAt (datetime), endAt (datetime)
- durationMinutes (computed)
- workType (string)
- hourlyRate?: number
- note?
- createdAt
- location? (same as above)
Visibility: ADMIN cannot list old worklogs; only owner can.

MeterReading:
- meterCode ('M1','M2',...)
- date
- value
- recordedBy
- createdAt

QuadSession:
- date
- startTime, endTime
- bufferUntil (endTime + 30m)
- totalQuads=4
- bookedQuads (sum)
- status: 'open'|'full'|'blocked'
- priceRuleSnapshot?: { base30:number, base60:number, groupDiscount?: { type:'percent'|'amount', value:number } }
- createdBy (instructor or owner)
- createdAt

QuadBooking:
- sessionId
- customer: { fullName, phone, telegramId? }
- duration: 30|60
- quadsCount: 1..4
- pricing: { total:number, discountApplied?: string }
- payments: { prepayment?: { amount:number, method:'erip'|'cash' }, eripPaid:number, cashPaid:number }
- status: 'pending_call'|'confirmed'|'cancelled'|'completed'
- assignedInstructor (telegramId)
- createdAt

========================
5) BUSINESS RULES (VALIDATION)
========================
COTTAGES:
- Checkout time is 12:00. Daily at 12:10, generate per-cottage climate_off tasks IF no check-in today for that cottage (or cottage is empty after checkout).
- Daily at 14:30, generate climate_on tasks for cottages WITH check-in today.
- Cottages tub: small only, boolean yes/no at booking.
- Cleaning tasks: when checkout occurs (or booking marked completed), create a cleaning task with tariff based on unit.

BATH:
- Two baths: B1 and B2; no overlap on same bath for statuses pending_call/awaiting_prepayment/confirmed.
- Min duration 3 hours. End time <= 22:00.
- Pricing:
  base = 150 for first 3h
  extra = (hours-3)*30 if >3
  tub small +150, tub large +180
  grill +10 (or use ServicePrice key)
  charcoal price from ServicePrice
- New guest request creates BathBooking status pending_call.
- Admin “accepts” -> awaiting_prepayment and optionally sets holdUntil (e.g., now+30m) to reduce race.
- Admin records prepayment -> status confirmed.
- Day-of notification: remind admin with phone, time, due amount.
- Payment close: admin sets eripPaid/cashPaid and status completed.
- Admin cannot browse historic bath bookings after incasation (only “today + upcoming” list endpoint).

QUADS:
- 4 quads, 1 instructor. Use QuadSessions that represent a group ride window.
- Session has start/end and buffer 30 minutes; thus next session start >= bufferUntil.
- Guests choose an existing session (recommended) and select quadsCount (<= remaining).
- If no suitable session exists, allow request to create a new session at allowed time (but do not auto confirm; instructor must confirm).
- Optional group discount: if session already has >=1 booking, apply discount (configurable).
- Day-before summary notification to instructor listing tomorrow’s sessions/bookings.

CASHBOX:
- Admin has ONE open shift at a time.
- On creating a booking with cash payment, auto create cash_in transaction.
- Expenses create expense transactions and reduce balance.
- Incasation: create cash_out transaction, close shift, lock history for admin (admin cannot list transactions/shifts afterwards; only can open new shift).
- Owner can see all shifts and transactions.

WORKLOGS:
- Admin can create WorkLog with start/end times; system computes duration.
- WorkType suggestions shown but custom text allowed.
- hourlyRate optional.
- After save, admin cannot list historical worklogs; owner can.
- Notify owner after each worklog saved (summary: employeeName, duration, rate if present).

GEOLOCATION:
- For specific actions (WorkLog create, CashTransaction create, Laundry kg entry later, Incasation), request location in webapp:
  - record lat/lng, accuracy, and label (on-site/off-site).
- Define “site geofence center” configurable in settings: “Zavyalovo-108 / Drewno”. If within radius (e.g., 300m), mark on_site else off_site.
- Do not block submission if user denies location; store location as null and mark “unknown”.

========================
6) API ENDPOINTS (REST)
========================
Auth:
- POST /auth/telegram (verify initData, return JWT)
Users (owner only):
- CRUD /users
Units & pricing (owner):
- GET/PUT /settings/site (geofence center, radius, closeTime=22:00)
- GET/PUT /prices (ServicePrice)
- GET/PUT /cleaning-tariffs

Ops (admin/owner):
- GET /ops/today (tasks + today’s checkins + today’s baths + today’s quads summary)
- POST /cottage-bookings
- PATCH /cottage-bookings/:id (status, payments)
- GET /cottage-bookings/upcoming (admin limited to upcoming only)
- POST /tasks/:id/complete

Bath (guest + admin):
- POST /guest/bath-bookings (creates pending_call)
- GET /guest/baths/availability?date=YYYY-MM-DD (show slots per bath)
- POST /admin/bath-bookings/:id/accept
- POST /admin/bath-bookings/:id/prepayment
- POST /admin/bath-bookings/:id/close-payment
- GET /admin/bath-bookings/upcoming (admin: upcoming only; owner: all)

Quads:
- GET /guest/quads/availability?date=YYYY-MM-DD (sessions list with remaining quads)
- POST /guest/quad-bookings (request)
- POST /instructor/quad-bookings/:id/confirm|cancel|complete
- POST /instructor/quad-sessions (create/adjust)
- GET /instructor/quad-schedule (upcoming)
- GET /owner/quad-analytics

Cashbox:
- POST /cash/shift/open
- POST /cash/transactions (cash_in, expense, cash_out/ incasation)
- POST /cash/shift/incasation (close)
- GET /cash/shift/current (admin ok)
- GET /owner/cash/shifts (owner only)
- GET /owner/cash/transactions (owner only)

WorkLogs:
- POST /worklogs (admin/owner)
- GET /owner/worklogs (owner only)

Meters:
- POST /meters/readings
- GET /owner/meters

Analytics (owner):
- GET /owner/analytics/summary?month=YYYY-MM
  include: bookings totals, cash vs erip, cleanings by tariff, tubs count & revenue, bath revenue, quads revenue, work hours totals.

========================
7) TELEGRAM BOT FLOWS
========================
Bot commands:
- /start (detect start param: banya|quad|ops)
- “Book Bath” -> open mini app at /webapp/#/guest/bath
- “Book Quads” -> open mini app at /webapp/#/guest/quads
- “Staff Panel” -> open mini app at /webapp/#/ops

Notifications:
- On new BathBooking (pending_call): send to ADMIN chat (or admin user) + OWNER.
- On admin accept: optionally notify guest “we will call you / pending prepayment”.
- On WorkLog created: notify OWNER.
- On daily reminders: send to ADMIN (and optionally OWNER summary).
- On day-before quad reminders: send to INSTRUCTOR.
Implement Telegram recipient mapping in settings: adminChatId, ownerChatId, instructorChatId.

========================
8) SCHEDULERS / CRON JOBS
========================
Timezone: Europe/Minsk (or configurable).
Daily:
- 12:10 generate climate_off tasks per cottage if no check-in today for that unit
- 14:30 generate climate_on tasks per cottage if check-in today for that unit
Weekly:
- Monday 18:00 trash prep reminder “tomorrow trash”
- Tuesday 08:30 trash reminder “today trash”
Monthly:
- Day 1 09:00 meters reminder (M1..Mn)
Daily morning 08:30:
- send admin a “Today summary” message: check-ins/out, baths, quads, key tasks.

Day-before:
- 18:00 send instructor tomorrow’s quad sessions + customer phones.

========================
9) FRONTEND (MINI APP) PAGES
========================
Routes:
- /ops (admin panel): Today, Cottage bookings quick-add, Bath upcoming list, Tasks list, Cashbox card, Worklog add, Incasation.
- /guest/bath: Choose bath1/2, date, start time, duration (>=3), options, contact form, submit.
- /guest/quads: Choose date, choose session, quadsCount, duration (30/60), contact, submit.
- /instructor: Quad schedule list, confirm/cancel, create session, price overrides.

UI must be clean & minimal:
- Lists with cards
- Forms with validation and clear errors
- “Owner-only analytics” can be a simple page with month picker and totals.

Location capture:
- For WorkLog save and CashTransaction save, attempt to get location via navigator.geolocation.
- Show “Location: on-site/off-site/unknown” tag (optional for owner view).

========================
10) PRICING CALC (IMPLEMENT EXACT)
========================
Bath total:
- base = price('bath_base_3h') default 150
- extraHours = max(0, hours - 3)
- extra = extraHours * price('bath_extra_hour') default 30
- tub = (none=0, small=price('tub_small') default 150, large=price('tub_large') default 180)
- grill = grill? price('grill') default 10 : 0
- charcoal = charcoal? price('charcoal') : 0
- total = base + extra + tub + grill + charcoal

Quads:
- duration 30 => price('quad_30m') default 40 per quad
- duration 60 => price('quad_60m') default 80 per quad
- total = base * quadsCount
- apply discount if session already has bookings and discount rule enabled.

========================
11) SECURITY & QUALITY
========================
- Validate Telegram initData on backend (HMAC) and issue JWT
- Rate limit guest booking endpoints
- Input validation via zod/class-validator
- Prevent overlap with atomic Mongo query and unique indexes where possible.
- Implement “admin visibility restriction” at API layer:
  - admin endpoints must filter to current open shift and “today/upcoming only”
  - owner endpoints have no such restriction
- Logging: store audit logs for key actions (incasation, payment close, accept/decline).

========================
12) DEPLOYMENT
========================
- docker-compose for local + VPS
- env vars:
  MONGO_URL, REDIS_URL, JWT_SECRET
  TELEGRAM_BOT_TOKEN
  TELEGRAM_ADMIN_CHAT_ID, TELEGRAM_OWNER_CHAT_ID, TELEGRAM_INSTRUCTOR_CHAT_ID
  WEBAPP_URL (public)
  TIMEZONE
  SITE_GEOFENCE_LAT, SITE_GEOFENCE_LNG, SITE_GEOFENCE_RADIUS_M

========================
13) DELIVERABLES
========================
- Working bot flows (start params, open mini app)
- Working mini app (ops + guest bath + guest quads + instructor)
- Scheduled notifications
- Basic owner summary analytics endpoint and page
- README with setup, env, and run steps

IMPLEMENT NOW:
1) Scaffold repo with NestJS + React
2) Implement auth + role guards
3) Implement Bath bookings (availability + request + admin accept + prepayment + close payment) with no overlap
4) Implement Quads sessions + bookings with buffer logic and capacity 4 quads
5) Implement cash shift + transactions + incasation with admin history lock
6) Implement worklogs with auto duration and owner notifications
7) Implement schedulers (12:10, 14:30, Mon 18:00, Tue 08:30, Day1 09:00, daily 08:30 summary, day-before quad reminder)
8) Minimal UI pages and telegram notifications

Do not ask the user questions; make reasonable defaults exactly as described. Make the system configurable in settings for prices, close time 22:00, and geofence. Keep code clean, typed, and with clear folder boundaries.
